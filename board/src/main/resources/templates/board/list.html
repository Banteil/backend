<!DOCTYPE html>
<html lang="kr" layout:decorate="~{layouts/layout}">
  <div layout:fragment="content">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title fw-semibold mb-4">게시판</h5>

        <div class="row mb-3">
          <form
            th:action="@{/board/list}"
            method="get"
            id="searchForm"
            class="d-flex"
            onsubmit="return validateSearch();"
          >
            <input
              type="hidden"
              name="page"
              id="searchPage"
              th:value="${requestDTO.page}"
            />
            <div class="col-md-2 me-2">
              <select name="type" class="form-select" id="searchType">
                <option value="">--- 검색 타입 ---</option>

                <option value="t" th:selected="${requestDTO.type == 't'}">
                  제목
                </option>

                <option value="a" th:selected="${requestDTO.type == 'a'}">
                  저자
                </option>
              </select>
            </div>

            <div class="col-md-6 me-2">
              <input
                type="text"
                name="keyword"
                class="form-control"
                placeholder="검색어를 입력하세요."
                th:value="${requestDTO.keyword}"
                id="searchKeyword"
              />
            </div>

            <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100">검색</button>
            </div>
          </form>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col">번호</th>
                <th scope="col">제목</th>
                <th scope="col">작성자</th>
                <th scope="col">작성일</th>
              </tr>
            </thead>

            <tbody>
              <tr th:each="book, i : ${list}">
                <th
                  scope="row"
                  th:text="${result.totalCount - ((result.pageRequestDTO.page - 1) * result.pageRequestDTO.size + i.index)}"
                >
                  1
                </th>
                <td>
                  <a
                    th:href="@{/board/read(id=${book.id}, page=${requestDTO.page}, type=${requestDTO.type}, keyword=${requestDTO.keyword})}"
                    th:text="${book.title}"
                    >제목입니다</a
                  >
                </td>
                <td th:text="${book.author}">홍길동</td>
                <td
                  th:text="${#temporals.format(book.createDateTime, 'yyyy-MM-dd HH:mm')}"
                >
                  2023-10-26 10:00
                </td>
                <td>
                  <a
                    th:href="@{/board/modify(id=${book.id}, page=${requestDTO.page}, type=${requestDTO.type}, keyword=${requestDTO.keyword}, fromPage='list')}"
                    class="btn btn-sm btn-primary"
                    >수정</a
                  >
                  <form
                    th:action="@{/board/remove}"
                    method="post"
                    style="display: inline"
                    th:data-booktitle="${book.title}"
                    onsubmit="return confirm('정말로 도서 ' + this.getAttribute('data-booktitle') + '을(를) 삭제하시겠습니까?');"
                  >
                    <input type="hidden" name="id" th:value="${book.id}" />
                    <button type="submit" class="btn btn-sm btn-danger">
                      삭제
                    </button>
                  </form>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(list)}">
                <td colspan="8" class="text-center">등록된 도서가 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div
          th:replace="~{fragments/pagination :: paginationFragment(${result})}"
        ></div>

        <div class="mt-3 text-end">
          <a th:href="@{/board/register}" class="btn btn-success">
            <i class="ti ti-plus me-1"></i> 새 도서 등록
          </a>
        </div>
      </div>
    </div>
  </div>

  <th:block layout:fragment="script">
    <script th:inline="javascript">
      const resultMessage = /*[[${msg}]]*/ "default";
      if (resultMessage) {
        Swal.fire({
          title: resultMessage,
          icon: "success",
        });
      } // 1. 검색 유효성 검사 함수
      function validateSearch() {
        const type = document.getElementById("searchType").value;
        const keyword = document.getElementById("searchKeyword").value.trim(); // 타입, 키워드 둘 다 없으면
        const pageInput = document.getElementById("searchPage");

        if (type === "" && keyword === "") {
          // 검색 조건이 아예 없는 것은 허용 (전체 목록 조회)
          return true;
        } // 타입은 있는데 키워드가 없거나 (사용자 요청: 타입을 지정하지 않으면 검색 안되게)
        if (type !== "" && keyword === "") {
          alert("검색어를 입력해주세요.");
          return false;
        } // 키워드는 있는데 타입이 없으면

        if (type === "" && keyword !== "") {
          alert("검색 타입을 선택해주세요.");
          return false;
        }

        // ✅ 검색 조건이 유효할 경우, 페이지를 1로 강제 설정하여 서버에 전송
        if (type !== "" && keyword !== "") {
          pageInput.value = 1;
        } else {
          // 검색 조건이 없는 경우 (전체 목록 재조회), 페이지 번호 파라미터가 URL에 남지 않도록 제거
          // searchPage 필드를 일시적으로 disabled 처리하여 전송되지 않게 합니다.
          pageInput.disabled = true;
        }

        return true;
      }
    </script>
  </th:block>
</html>
